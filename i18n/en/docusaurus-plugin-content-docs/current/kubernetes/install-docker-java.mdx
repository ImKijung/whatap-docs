---
id: install-docker-java
title: Installing Docker Java
description: This step allows you to install the agent to monitor Java applications in the container.
tags:
  - Kubernetes
  - Kubernetes Monitoring
  - Application Installation
  - Java
toc_max_heading_level: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

At the bottom of **_Management_** > **_Agent installation_**, click **_Install Application_** > Select the **_Docker Java_** tab in Install guide.

This process adds the settings for applying the agent to the JVM option of the Java application running on the Docker container and packages the container images as follows:

:::note 

-   EKS Fargate is to be supported later. 

-   Git example code is provided to help you understand the Java application integration process. See [the following](https://github.com/whatap/kuber-apm-boilerplate/tree/main/java/springboot).

:::

## Download agent

<Tabs groupId='k8stype2'>

<TabItem value="dockerinstall" label="Docker Install" default>

To install the WhaTap application agent, create the _whatap.conf_ file. Change `{YOUR_PROJECT_ROOT}` to the top-level path of the project to install the agent.

```bash
cat >{YOUR_PROJECT_ROOT}/whatap.conf <<EOL
whatap.server.host={proxyServer}
EOL
```

:::note

The _whatap.conf_ file can be managed using the ConfigMap function in the user Kubernetes environment.

:::

<Tabs>

<TabItem value='latest' label='Including the latest version of the agent in the application image' default>

The following guides you to include **the latest version of the agent** in the application image.

1.  To include the WhaTap agent in the application image, add the following in the Dockerfile's final image build step. Change `{YOUR_PROJECT_ROOT}` to the top-level path of the project to install the agent.

    ```docker
    # Create the WhaTap agent directory in the user container
    RUN mkdir -p /whatap

    # Copy the WhaTap Java agent to the user container
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap

    # Copy the created whatap.conf file to the user container
    COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
    ```

2.  Add the following to the startup command of Dockerfile.

    ```bash
    -javaagent:/whatap/whatap.agent.kube.jar -Dwhatap.micro.enabled=true
    ```

    See the following definition example of the following Dockerfile. 

    ```docker title='Dockerfile' showLineNumbers {4,7}
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap
    COPY ./whatap.conf /whatap
    COPY ./target/myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent.kube.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

3.  Build the Docker. Change `{YOUR_DOCKERFILE_DIR}` to the path where Dockerfile is located. 

    ```docker
    cd {YOUR_DOCKERFILE_DIR}
    docker build -t {IMAGE_NAME} .
    ```

</TabItem>

<TabItem value='choice' label='Including the specified version of the agent in the application image' default>

The following guides you to include **the specified version of the agent** in the application image.

1.  To include the WhaTap agent in the application image, add the following in the Dockerfile's final image build step. Change `{YOUR_PROJECT_ROOT}` to the top-level path of the project to install the agent.

    ```docker
    # Create the WhaTap agent directory in the user container
    RUN mkdir -p /whatap

    # Copy the WhaTap Java agent to the user container
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap

    # Copy the created whatap.conf file to the user container
    COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
    ```

2.  Check the version of the WhaTap agent. 

    ```bash
    docker run whatap/kube_mon ls /data/agent/micro | grep -E 'whatap\.agent-(.*?\.)(.*?\.)(.*?\.)jar' | sort | tail -1

    # Output example
    ## whatap.agent-X.Y.Z.jar
    ```

3.  Add the following to the startup command of Dockerfile. In **X.Y.Z**, enter the agent version that you checked before. 

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```

    See the following definition example of the following Dockerfile.

    ```docker title='Dockerfile' showLineNumbers {4,7}
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap
    COPY ./whatap.conf /whatap
    COPY ./target/myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

4.  Build the Docker. Change `{YOUR_DOCKERFILE_DIR}` to the path where Dockerfile is located.

    ```docker
    cd {YOUR_DOCKERFILE_DIR}
    docker build -t {IMAGE_NAME} .
    ```

</TabItem>

</Tabs>

</TabItem>

<TabItem value="direct" label="Direct Installation">

1.  Select **_Download_** to download the installation file (_whatap.agent.java.tar.gz_).

2.  Upload the dockerfile to the server and then unzip the file.

    :::info

    To download to the installation server, execute the following command.

    ```bash
    wget https://api.whatap.io/agent/whatap.agent.java.tar.gz
    ```

    :::

3.  When unzipped, the _whatap_ directory is created. Check the settings in the _whatap.conf_ file under the _whatap_ directory, and then modify it as follows:

    ```ini
    license={licenseKey}
    whatap.server.host={proxyServer}
    ```

4.  Add the following to the startup command of Dockerfile. Check the agent file under the _whatap_ directory, and then enter the version in **X.Y.Z**.

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```

    See the following definition example of the following Dockerfile.

    ```bash title='Dockerfile'
    FROM openjdk:8-jdk-alpine
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY ./whatap.agent-X.Y.Z.jar /whatap/
    COPY ./whatap.conf /whatap/
    COPY ./target/myApp.jar myApp.jar
    COPY ./paramkey.txt /whatap/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

:::note

-   _whatap-virtual-X.Y.Z.jar_: Monitoring target (sample application)

-   _whatap.agent-X.Y.Z.jar_: WhaTap agent

-   If the agent's file name is _whatap.agent-1.2.3.jar_, change the **X.Y.Z** part to **1.2.3**.

-   For more information about addition of JVM options, see [the following](https://docs.whatap.io/java/install-agent#addjvmopt).

:::

</TabItem>

</Tabs>

:::tip

For Java 17 or later, add the `--add-opens=java.base/java.lang=ALL-UNNAMED` option related to the reflection.

:::

### Creating the paramkey file

Create the _paramkey.txt_ file in the top-level path of the project, and then enter a 6-letter alphanumeric password.

-   The _paramkey.txt_ file is used when decrypting parameters during monitoring. 

-   The password example is as follows: `ABCDEF`

## Configuring the container environment variables

After building Docker, set **container environment variables** in the Kubernetes environment. Add the following items in the _yaml_ file for releasing the application. 

```yaml
env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}
- name: OKIND
	value: {YOUR_OKIND_NAME}
- name: license
	value: {licenseKey}
- name: whatap_server_host
	value: {proxyServer}
- name: whatap_micro_enabled
	value: "true"
```

See the following example:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: #DeploymentName
  labels:
    app: #AppLabel
spec:
  selector:
    matchLabels:
      app: #AppLabel
	replicas: 3
  template:
    metadata:
      labels:
        app: #AppLabel
		spec:
		  containers:
			- name: #ContainerName
        image: nginx
        ports:
        - containerPort: 80
			  env:
		    - name: NODE_IP
	        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
				- name: NODE_NAME
		      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
		    - name: POD_NAME
		      valueFrom: {fieldRef: {fieldPath: metadata.name}}
				- name: OKIND
          value: #DeploymentName
				- name: license
					value: {licenseKey}
				- name: whatap_server_host
					value: {proxyServer}
				- name: whatap_micro_enabled
					value: "true"
```

:::note

**Roles of environment variables**

-   `NODE_IP`: Collects the IP address of the node where the current Pod has been hosted.

-   `NODE_NAME`: Collects the name of the node where the current Pod is running.

-   `POD_NAME`: Collects the name of the current Pod.

-   `OKIND` (optional): Groups applications for Pods. If set to a deployment name, the corresponding Pods are grouped together.

-   `license`: Key for agent authentication.

-   `whatap_server_host`: Host IP of the WhaTap collection server

-   `whatap_micro_enabled`: Enables integration with containers.

:::

{@include: _check-install-agent.mdx} 
