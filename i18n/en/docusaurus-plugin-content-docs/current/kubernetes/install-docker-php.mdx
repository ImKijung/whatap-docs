---
id: install-docker-php
title: Installing the docker PHP
description: This step allows you to install the agent to monitor PHP applications in the container.
tags:
  - Kubernetes
  - Kubernetes Monitoring
  - Application Installation
  - PHP
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

This process applies the WhaTap monitoring agent to the PHP application running on the Docker container and packages the container image.

## Download agent

Install the whatap-php package when building your PHP application docker image.

<Tabs>
<TabItem value="rc" label="Red Hat/CentOS" default>

```docker title='Red Hat/CentOS'

RUN rpm -Uvh https://repo.whatap.io/centos/5/noarch/whatap-repo-1.0-1.noarch.rpm
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="du" label="Debian/Ubuntu" default>

```docker title='Debian/Ubuntu'

RUN wget https://repo.whatap.io/debian/release.gpg -O -| apt-key add -
RUN wget https://repo.whatap.io/debian/whatap-repo_1.0_all.deb
RUN dpkg -i whatap-repo_1.0_all.deb
RUN apt-get update
RUN apt-get install -y whatap-php

```

</TabItem>

<TabItem value="al" label="Amazon Linux" default>

```docker title='Amazon Linux'

RUN rpm --import https://repo.whatap.io/centos/release.gpg
RUN echo "[whatap]" | tee /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "name=whatap packages for enterprise linux" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "baseurl=https://repo.whatap.io/centos/latest/\$basearch" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "enabled=1" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "gpgcheck=0" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="apl" label="Alpine Linux" default>

```docker title='Alpine Linux'

RUN wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-php.tar.gz
RUN tar -xvzf whatap-php.tar.gz -C /

```

</TabItem>

</Tabs>

## Agent CONFIG.

-   Use the following command to set the installation script. If you enter the WhaTap access key and server IP, the PHP environment data is automatically collected.

    ```docker

    RUN (echo "[Access Key]"; echo "[Server IP]")|/usr/whatap/php/install.sh

    ```

-   Using the following method, you can directly enter the PHP environment settings. 

    ```docker

    # RUN /usr/whatap/php/install.sh -l [Access Key] -s [Server IP] -v [PHP version x.x] -i [php.ini full path] -p [Process Name] -z [thread safety]
    RUN /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -v 7.0 -i /etc/php.ini -p httpd [-z]

    ```

## Kubernetes's environment variables and volumes

Following the instructions below to set the environment variables and the volume.

<Tabs>
<TabItem value="basic" label="Default" default>

To collect the Node and Pod information in transactions, set the environment variables for `NODE_IP` and `NODE_NAME`, `POD_NAME`. Mount the volatile volumes for WhaTap configuration files and log files.

```docker

env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}

```

</TabItem>

<TabItem value="eks" label="EKS Fargate" default>

-   **Adding the shareProcessNamespace setting**

    Add `shareProcessNamespace` and `SERVICE ACCOUNT` to observe user Pod resources to fields in _.spec_ of Deployment or ReplicaSet.

    ```docker

    apiVersion: apps/v1
    kind: Deployment
    ...
    spec:
    ...
        spec:
          shareProcessNamespace: true
          serviceAccount: whatap
    ...

    ```

-   **Setting the container environment variables in Kubernetes**

    To collect the Node and Pod information in transactions, set the environment variables for `NODE_IP` and `NODE_NAME`, `POD_NAME`. Mount the volatile volumes for WhaTap configuration files and log files.

    ```docker

    env:
    - name: NODE_IP
      valueFrom: {fieldRef: {fieldPath: status.hostIP}}
    - name: NODE_NAME
      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
    - name: POD_NAME
      valueFrom: {fieldRef: {fieldPath: metadata.name}}

    ```

-   **Adding the Sidecar agent**

    Add the whatap-node-agent sidecar container to collect the user Pod resource usage.

    ```docker

    ...
      - name: whatap-node-agent
        image: whatap/kube_mon_sidecar
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
        ports:
          - name: nodeport
            containerPort: 6600
        env:
          - name: NODE_IP
            valueFrom:
              fieldRef:
                fieldPath: status.hostIP
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
            envFrom:
            - configMapRef:
                name: node-license
    volumes:
    ...

    ```

</TabItem>

</Tabs>

## Starting the application monitoring

<Tabs>
<TabItem value="cm" label="Command" default>

Add the whatap-php service startup command before the application startup command. 

```docker title='Red Hat/CentOS, Debian/Ubuntu, Amazon Linux'

sh -c "/etc/init.d/whatap-php start && [Application Startup Command]"

```

```docker title='Alpine Linux'

sh -c "/usr/whatap/php/whatap-php start && [Application Startup Command]"

```

</TabItem>

<TabItem value="sup" label="Supervisor" default>

In case of starting the application as supervisor, see the following code to add the whatap-php service.

```docker

RUN echo "[program:whatap-php]" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "command = /etc/init.d/whatap-php start" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "user = root" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autostart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autorestart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile = /dev/stdout" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile = /dev/stderr" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf

```

</TabItem>

</Tabs>

Execute the following command to check whether the WhaTap service has been run normally. 

```docker

ps -ef | grep whatap_php

```

## Checking the agent installation

To check whether the agent has been installed, go to **_Dashboard_** > **_Application Service Dashboard_**.

If you have manually installed the downloaded file but cannot see the agent in **_Dashboard_**, check the following.

-   Execute the command, `ps -ef | grep whatap` in the container, and then check whether the agent options have been applied properly.
-   Check the content of the container in the _/usr/whatap/php/logs_ path. The file name of the agent log is displayed as _logs/`{boot or install}`-yyyymmdd.log_.
