---
id: about-apm-hitmap-class
title: ヒートマップトランザクションの検索
description: ヒートマップトランザクションのメニューを使用して、Webアプリケーションサーバ(Web Application Server)の問題を特定し、トラブルに対応する方法を紹介します。
tags:
  - アプリケーション
  - アプリケーションモニタリング
  - ヒートマップ
  - トランザクション
  - ヒートマップトランザクション
  - APM
keywords:
  - アプリケーション
  - アプリケーションモニタリング
  - ヒートマップ
  - トランザクション
  - ヒートマップトランザクション
  - APM
displayed_sidebar: learningSidebar
---

この文書では、[WhaTapモニタリングサービス](https://service.whatap.io)の、**_ヒートマップトランザクション_**メニューを使用してウェブアプリケーションサーバ(Web Application 
 Server)の問題を特定し、トラブルに対応する方法を紹介します。 

アプリケーションモニタリングマネージャーは、業務内容に応じて、さまざまな要因をモニタリングしたいと考えています。サーバー担当者はCPU、メモリ、ディスク、ネットワークなどのリソースをモニタリングし、リソースをどの程度使用しているかを確認する必要があります。DB担当者は、DBクエリのパフォーマンスを向上させるための指標を表示する必要があります。 

一方、従来のモニタリング方法では、サービス(AP) 担当者は通常、(Heap)ヒープ使用量とCPU使用率を確認するだけでした。ただし、この方法では、サービス(AP)の問題が何であるか特定することができません。サービス(AP)で最も重要なことは、ユーザーのリクエストに適切に応答するかどうか、どれだけ迅速に、エラーなく応答するかです。これらを把握するためには、ユーザーのリクエストが正しく満たされたかどうかを確認するプロセスが必要です。ユーザーのリクエストの1つ1つをリクエストと呼び、このリクエストをサーバーで処理と応答するプロセスをトランザクション(Transaction)として定義されます。 

WhaTapモニタリングサービスでは、トランザクションを「進行中のトランザクション」と「終了したトランザクション」に区分し、サービス(AP)のトラブル状況を把握することができます。**_アプリケーションダッシュボード_**メニューの**_ヒートマップ_**ウィジェットでは、「終了した個々のトランザクション」を分布図形式のチャートで確認することができます。ヒートマップチャートは、5秒単位で終了したトランザクション情報を収集し、ポイント単位で表現するウィジェットです。このチャートから想定通りに1秒かかるトランザクションが想定とは異なり、2秒ほどかかる場合、つまり応答時間が2倍以上かかるトランザクションを見つけることで、トラブルの原因を分析できます。

## パターン分析{#about-hitmap-pattern-analysis}

分布図チャートの形状によってどのようなトラブルが発生したのかを確認する方法について説明します。

**_ヒートマップトランザクション_**は、時間の経過とともにユーザーのリクエストに対する応答時間を分布図の形式で表現するチャートです。**_アプリケーションダッシュボード_**でヒートマップウィジェットの右上に! [右方向アイコン](/img/right-arrow.svg)を選択すると、**_ヒートマップトランザクション_**メニューに入ることができます。

![ヒートマップトランザクション](/img/best-p/best-p-hitmap-transaction.png)

横軸はトランザクションの終了時間、縦軸は応答時間です。トランザクションを終了した時間ごとにユーザのリクエスト(Request)に対する応答(Response) 時間をチャート上に四角形で表現します。これにより、ユーザーのリクエストに正常に応答したかどうかを把握できます。ヒートマップトランザクションチャートの四角いボックスの色は、次のような意味を持っています。

-   <span class='normal'>青色</span>： 正常トランザクション
-   <span class='slow'>オレンジ</span>、<span class='vslow'>赤色</span>：エラーが発生したのか、応答リクエストが拒否されたのか、エラー頻度に応じて赤に近い色で表現されます。

このチャートで最も重要な点は、トランザクションボックスが縦または横に並んでいる状況です。次のヒートマップパターンを参照してください。

<div class='pattern-intro'>

<div class='pattern-img'>

![縦線パターン](https://www.whatap.io/ko/blog/113/img/blog_03.webp)

</div>

<div>

**縦線が一時的に現れるパターン**です。縦線が発生する場合は、トランザクションの応答時間は異なりますが、終了時間は同じであることを意味します。トランザクション処理中に一時的にロック(Lock)が発生すると、トランザクションの処理を待機します。(Lock)ロックが解除されると待機中のトランザクションは同じ時間に終了します。これにより、縦線が作成されます。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![横線パターン](https://www.whatap.io/ko/blog/113/img/blog_04.webp)

</div>

<div>

**横線が現れるパターン**です。10秒のタイムアウト条件でそのリソースが不足すると、多くのトランザクションは10秒待機後にタイムアウトエラーが発生します。この時、ヒートマップの10秒後に横線が発生します。タイムアウト後に再試行するロジックがある場合は、上図のように横線が10秒単位で繰り返します。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![フライングパターン](https://www.whatap.io/ko/blog/113/img/blog_05.webp)

</div>

<div>

**波のように見えるフライングパターン**は、特定のリソースやログなどの共通リソースが不足しているために間隔を置いて表示されるパターンです。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![過負荷パターン](https://www.whatap.io/ko/blog/113/img/blog_06.webp)

</div>

<div>

**過負荷パターン**は、全体または一部の応答に一時的に問題を引き落とすトランザクションが一度に密集するときに発生するパターンです。

</div>
</div>

<div class='pattern-intro'>
<div class='pattern-img'>

![暴走パターン](https://www.whatap.io/ko/blog/113/img/blog_07.webp)

</div>

<div>

**暴走パターン**は、大量のトランザクションのリクエストや負荷が発生した場合、応答時間が全体的に増加するパターンです。

</div>
</div>

パターンが発生した場合に、パターンの原因となっている要因がサーバーの内部にあるか外部あるかを特定することが重要です。次の図のような構造でシステムを設計したと仮定します。

![](/img/best-p/hitmap-transaction-sample.png)

チャート下の領域は、ほとんど応答時間が速いトランザクションであるため、パターンを探すことはそれほど意味がありません。上の領域の遅い区間で作成されたパターンの共通点を探すことが必要です。縦線パターンが発生した時、サービス(AP)でロック(Lock)が発生した場合、1つのウェブアプリケーションのみパターンが発生します。逆に、外部に接続されたDatabaseで(Lock)ロックが発生すると、すべてのウェブアプリケーションでパターンが発生します。 

チャート領域をドラッグすると、ドラッグした領域のトランザクション情報を画面下の**_TXトレース_**一覧に読み込むことができます。**_エージェント名_**カラム項目を使用して問題の原因を把握することもできます。また、右側の**_アプリケーション_**ウィジェットでは、エージェントをグループ化して一覧として表示します。

トラブルの原因に関する共通点を見つけることが目的です。まず、同じアプリケーションで問題が発生の有無を確認してください。第２に、同じURLで問題が発生したかどうかを確認してください。また、クライアントIPが同じかどうかを確認することもできます。

## 区間およびスタック分析

トラブルの原因が外部ではなく内部の問題であるかどのように確認できるでしょうか？WhaTapは、**アクティブスタック**という技術を使用して、実行中のトランザクションのスタック情報を収集します。スタック情報は10秒ごとに収集され、収集されたデータは統計情報として確認できます。
また、サービスのロジックを実行する各メソッド、SQL、外部呼び出し情報も含まれます。 

内部的な問題の場合、各トランザクションの実行履歴を時間ごとに確認し、速度が遅くなった区間を特定することで、問題を見つけて解決することができます。外部の問題の場合は、SQLと外部呼び出し情報を確認できます。

例えば、縦線パターンでロックが発生する要因を探すには、同じパターン内で最も遅いトランザクションと最も速いトランザクションの接点を確認する方法があります。ヒートマップチャートでパターンが発生した領域をドラッグしてください。**_TXトレース_**一覧にドラッグした領域のトランザクション情報を読み込みます。**_TXトレース_**一覧を経過時間で並べ替えてから、最も長くかかったトランザクションを選択してください。選択したトランザクションに関する詳細情報が含まれた**_統計_**ウィンドウが表示されます。

![](/img/best-p/hitmap-transaction-sample-02.png)

**_テーブルビュー_**タブで段階別**_区間時間_**と**_所要_**時間を確認することができます。**_区間時間_**は各段階が開始または終了した時間、**_所要_**は各メソッドの開始から終了までの総所要時間です。**_ギャップ_**は、先に実行したメソッド間の間隔です。

**_テーブルビュー_**タブで遅くなった区間を見つけることができます。同様に、最も速かったトランザクションが遅くなった区間を確認してください。共通点を見つけることができます。遅くなった区間がサービス(AP)のロジックによって発生した場合、**_アクティブスタック_**を確認してください。**_アクティブスタック_**ボタンをクリックすると、詳細情報が含まれたウィンドウが表示されます。**_アクティブスタック_**が実行されたメソッドとの相関関係を確認するには、そのステップの番号を参照してください。この番号を**_ツリービュー_**タブをクリックし、番号を確認します。**_ツリービュー_**タブだけではメソッドがいつ開始されたかを把握することができないため、**_テーブルビュー_**タブから**_区間時間_**を確認してください。 

![](/img/best-p/hitmap-transaction-sample-03.png)

:::note

-   **アクティブスタック**は10秒に一度スナップショットを保存しているため、どの区間でも確認できます。応答時間が長くなる区間を確認する確率が高くなるため、**アクティブスタック**を通じて区間が開いたポイントを見つけることができます。
-   **_TXトレース_**一覧で**アクティブスタック**を含むトランザクションは、 <span class='mark active'>A</span>アイコンが表示します。

:::

ヒートマップチャートでトランザクションを表示するトランザクションを見つけることが目的です。一緒に参照するトランザクションを確認して、応答時間や終了時間に影響を与える要因を特定する必要があります。アプリケーションですべてのメソッドを追跡すると、区間分析が可能ですが、オーバーヘッドを起こして応答時間に歪みを与える可能性があります。そのため、選択されたクラスメソッドのみ追跡する必要があります。その選択ポイントは運用者の観点のみで決定しますが、トラブルの原因となる(Lock)ロックやその他の要因が追跡から除外されることがあります。この除外される部分をサポートするのが**アクティブスタック**です。 

WhaTapのモニタリングサービスは、アプリケーションサーバを運用中に常時繰り返される問題を発見するために繰り返し**アクティブスタック**をスナップショットに記録します。トラブルを引き起こす重要な要因を見つけることが可能です。この方法で収集したデータを統計的に確認できるメニューは**_分析_**>**_スタック_**です。スタックの詳細については、[次の文書](https://docs.whatap.io/java/analysis-apm)を参照してください。

:::note

![](/img/best-p/hitmap-transaction-sample-08.png)

-   **_統計_**ウィンドウの右上に**_もっと見る_**ボタンをクリックすると、トランザクションに関する基本情報を展開して確認することができます。エラー情報、クライアントIP、使用機器、OS、国の情報などを提供します。また、パッチ件数および時間、SQL件数および時間などを確認し、どれだけ多くの呼び出しを使用しているのかを把握することができます。
-   上記の情報とグラフの概要は、画面の中央に位置する**_ダイアグラム_**チャートです。詳細については、[次の文書](https://docs.whatap.io/java/trs-profile)を参照してください。

:::

## 呼び出し関係分析

-   **_メソッド要約_**

    **_統計_**ウィンドウの**_メソッド要約_**タブを選択してください。SQLと同様に、メソッドも１つのトランザクションでどれだけ多く呼び出された回数を確認することができます。 

    ![](/img/best-p/hitmap-transaction-sample-05.png)

    この情報に基づいて、繰り返し実行されるメソッドがあるかどうか、同じメソッドが繰り返し呼び出されているかを確認し、改善点を探すことができます。

-   **_SQL要約_**

    トラブルの原因が内部ロジックではなくSQLである場合を説明します。１つのトランザクション内でSQLの実行を統計的に確認するには、**_統計_**ウィンドウの**_SQL要約_**タブを選択してください。

    ![](/img/best-p/hitmap-transaction-sample-04.png)

    同じSQLをどれだけ繰り返して呼び出すかを確認してください。ロジックから呼び出す回数を減らしたり、他の解決策を見つけてDBの負担を軽減できる方法を見つける必要があります。DataBaseの負担を軽減することは、サーバ運用にとって非常に重要です。アプリケーションサーバーはScale-Outができます。常にリソースを継続的に増やすことが可能です。一方、DataBaseのパーティションを分割することは、アプリケーションに対して膨大な開発が伴います。パフォーマンスチューニングの基本は、アプリケーションのDataBaseの負荷を軽減するために、可能な限り適切である必要があります。 

-   **_HTTPリクエスト要約_**

    **_統計_**ウィンドウの**_HTTPリクエスト要約_**タブを選択してください。HTTPリクエストのリクエスト件数、合計時間、平均時間を提供します。

-   **マルチトランザクション**

    モノリティック環境では単一のAPM構成でした。この場合、APMのトランザクションのみを確認します。最近では、マイクロサービスアーキテクチャなどの技術トレンドが主流です。単一のAPMが小さな単位に分割されると、それに応じて収集する必要のあるトランザクションの数が増加します。このような場合、分割されたトランザクションをすべて収集することは非常に負荷がかかるため、1つのトランザクションに連携したトランザクションをまとめて収集する必要があります。このように他のAPMに関連付けられたトランザクションを、WhaTapによって、**マルチトランザクション**として定義されます。**_TXトレース_**一覧で**マルチトランザクション**を含むトランザクションは、 <span class='mark multi'>M</span>アイコンを表示します。

    ![](/img/best-p/hitmap-transaction-sample-07.png)

    **_統計_**ウィンドウで**_マルチTXチャート_**ボタンを選択してください。トランザクションごとの連携情報はチャートで確認できます。**_マルチTXテーブル_**タブを選択すると詳細情報が確認できます。

    :::note

    -   マルチトランザクション追跡の詳細については、[次の文書](https://docs.whatap.io/java/trs-multi-trace)を参照してください。
    -   トランザクションによっては、**_マルチTXテーブル_**タブをサポートしない場合があります。

    :::

## トランザクションログ分析

![](/img/best-p/hitmap-transaction-sample-06.png)

 **_統計_**ウィンドウの**_トランザクションログ_**タブでは、トランザクションが実行中に記録されたログから追加・改善すべき事項を探すことができます。

## 最終作業

**_ヒートマップトランザクション_**からパターンを確認し、共通点を識別します。特定された共通点からメソッド間隔を分析します。十分なセグメント情報が不足の場合は、**アクティブスタック**を使用して追加情報を確保してください。次にSQL、メソッド、HTTPリクエスト情報を確認して繰り返し負荷の大きいロジックの改善点を見つけます。WhaTapモニタリングサービスの**_ヒートマップトランザクション_**のモニタリング業務の効率を引き上げることができます。

:::note 

**参考資料**

-   [月次WhaTap：アプリケーションモニタリングプロファイルを使用する](https://www.whatap.io/ko/blog/71/)
-   [月次のWhaTap：個々のトランザクション分布図を確認したい場合は？](https://www.whatap.io/ko/blog/79/)
-   [月次のWhaTap：大切な休暇を保護するためのWhaTapマシンラーニング](https://www.whatap.io/ko/blog/113/)
-   [WhaTap5分セミナー：ヒートマップの縦横ラインの分析](https://youtu.be/JHVYfJjtYQo)

:::
