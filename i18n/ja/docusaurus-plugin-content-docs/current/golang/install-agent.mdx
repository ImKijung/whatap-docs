---
id: install-agent
title: エージェントのインストール
description: Golang環境のアプリケーションサーバーにエージェントをインストールする方法を提供します。
tags:
  - Golang
  - エージェントのインストール
---

import TR from '@site/src/components/TR';

モニタリング対象アプリケーションサーバーからUDP通信にデータを配信します。また、WhaTap収集サーバーにデータを送信するには、同じサーバにエージェントをインストールする必要があります。インストール方式は、パッケージインストールで可能です。

1.  WhaTapリポジトリ（Repository）をインストールしてください。

2.  whatap-agent Linuxパッケージ（yum, apt-get）をインストールしてください。

3.  whatap-agentサービスを実行してください。

![Golang Monitoring](https://img.whatap.io/media/images/golang_system.png)

WhaTapモニタリングサービスを使用するには、[会員登録](https://www.whatap.io/ko/signup/)後、プロジェクトを作成し、ターゲットサーバーにエージェントをインストールする必要があります。

{@include: ../getting-started/_create-project-v2.mdx}   

{@include: ../getting-started/_accesskey-v2.mdx} 

## エージェントダウンロード

**アクセスキー**を発行されたら、次のコマンドを使用してエージェントをダウンロードしてください。

<Tabs groupId="golang">
<TabItem value="redhat-centos" label="Red Hat/CentOS">

```bash title='SH'
## パッケージリポジトリ登録
$ sudo rpm -Uvh https://repo.whatap.io/centos/5/noarch/whatap-repo-1.0-1.noarch.rpm

## パッケージインストール
$ sudo yum install whatap-agent
```

</TabItem>
<TabItem value="debian-ubuntu" label="Debian/Ubuntu">

```bash title='SH'
## パッケージリポジトリ登録
$ wget https://repo.whatap.io/debian/release.gpg -O -|sudo apt-key add -
$ wget https://repo.whatap.io/debian/whatap-repo_1.0_all.deb
$ sudo dpkg -i whatap-repo_1.0_all.deb
$ sudo apt-get update

## パッケージインストール
$ sudo apt-get install whatap-agent
```

</TabItem>
<TabItem value="amazonlinux" label="Amazon Linux">

```bash title='SH'
## パッケージリポジトリ登録
$ sudo rpm --import https://repo.whatap.io/centos/release.gpg
$ echo "[whatap]" | sudo tee /etc/yum.repos.d/whatap.repo > /dev/null
$ echo "name=whatap packages for enterprise linux" | sudo tee -a /etc/yum.repos.d/whatap.repo > /dev/null
$ echo "baseurl=https://repo.whatap.io/centos/latest/\$basearch" | sudo tee -a /etc/yum.repos.d/whatap.repo > /dev/null
$ echo "enabled=1" | sudo tee -a /etc/yum.repos.d/whatap.repo > /dev/null
$ echo "gpgcheck=0" | sudo tee -a /etc/yum.repos.d/whatap.repo > /dev/null

## パッケージインストール
$ sudo yum install whatap-agent
```

</TabItem>
<TabItem value="alpinelinux" label="Alpine Linux">

[whatap-agent.tar.gz](https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-agent.tar.gz)ファイルをダウンロードし、「/」ディレクトリ基準で圧縮を解凍してください。_/usr/whatap/agent_ パスにモニタリングファイルを作成します。

```bash title='SH'
$ wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-agent.tar.gz
$ tar -xvzf whatap-agent.tar.gz -C /
```

</TabItem>
<TabItem value="al-docker" label="Alpine Linux Docker">

[whatap-agent.tar.gz](https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-agent.tar.gz)ファイルをダウンロードしてから、 _/usr/whatap/agent_ パスに圧縮を解凍してください。

```bash title='SH'
FROM alpine

RUN apk update && apk upgrade

# Install WhaTap Golang monitoring agent
RUN wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-agent.tar.gz
RUN tar -xvzf whatap-agent.tar.gz -C /
```

</TabItem>
</Tabs>

<details>
<summary>エージェント構成ファイル</summary>

モニタリング情報を収集するトレーサー、収集した情報をサーバーに転送するエージェント、トレーサーとエージェントをサーバーへ動的に適用するインストールスクリプト ファイルで構成されます。

-   _whatap-agent_：エージェント、トレーサーからUDPとして転送した情報を収集サーバーに転送するプログラムです。

-   _/etc/init.d/whatap-agent_：サービスのスクリプトファイルです。

-   _whatap_agent_：サービスの実行ファイルです。

-   _whatap.conf_：設定情報および収集サーバーのIP、アクセスキーを入力するファイルです。

-   _whatap-boot-`yyyymmdd`.log_：エージェントログファイルです。(パス：_/usr/whata/agent/log_)

</details>

## 에이전트 설정{#set-agent}

### 기본 설정하기

다음 명령어를 차례로 실행해 _whatap.conf_ 파일에 **액세스 키**와 **수집 서버 IP 주소** 등을 설정하세요.

-   アプリケーションの開始スクリプトパスに_whatap.conf_ファイルを作成してください。 

-   `WHATAP_HOME`環境変数を設定しない場合は、アプリケーション開始スクリプトのパスを_whatap.conf_ファイルパスとして認識します。

```bash title='SH'
# 스크립트 실행 경로에 whatap.conf 파일 생성
$ echo "license={액세스 키}" >> ./whatap.conf
$ echo "whatap.server.host={수집 서버 IP 주소}" >> ./whatap.conf
$ echo "app_name={애플리케이션 이름}" >> ./whatap.conf

# 애플리케이션 실행
./app
```

-   `license`：**アクセスキー**を入力してください。

-   `whatap.server.host`: **수집 서버 IP 주소**를 입력하세요.

-   `app_name`: 애플리케이션 이름을 입력하세요. 문자열을 이용해 사용자 설정할 수 있습니다.

### `WHATAP_HOME` 환경 변수 설정하기

_whatap.conf_ 파일 경로를 `WHATAP_HOME` 환경 변수로 설정할 수 있습니다. `WHATAP_HOME` 경로를 우선 생성하세요.

```bash
# WHATAP_HOME 경로 우선 생성 후 whatap.conf 파일 경로 설정
mkdir ./whatap_home
echo "license={액세스 키}" >> ./whatap_home/whatap.conf
echo "whatap.server.host={수집 서버 IP 주소}" >> ./whatap_home/whatap.conf
echo "app_name={애플리케이션 이름}" >> ./whatap_home/whatap.conf

# 애플리케이션 실행
WHATAP_HOME=./whatap_home ./app
```

### 프로세스 별 에이전트 이름 설정{#duplicate_appname}

2개 이상의 프로세스로 실행되는 애플리케이션에서 1개의 _whatap.conf_ 파일을 공유하면 사용자가 설정한 변경 사항이 정상 반영되지 않을 수 있습니다. 프로세스 별로 각각의 _whatap.conf_ 파일을 설정할 것을 권장합니다.

에이전트 이름이 중복되지 않도록 사용자는 문자열을 에이전트 이름에 추가해 구분할 수 있습니다. `app_name` 옵션으로 설정한 값이 에이전트 이름의 가장 앞 부분에 추가됩니다.

同一インスタンス、同一コマンドで実行されるエージェント名が重複する現象を回避できます。 

```bash
# WHATAP_HOME 경로 우선 생성 후 whatap.conf 파일 경로 설정
mkdir ./whatap_home
echo "license={액세스 키}" >> ./whatap_home/whatap.conf
echo "whatap.server.host={수집 서버 IP 주소}" >> ./whatap_home/whatap.conf
echo "app_name={애플리케이션 이름-1}" >> ./whatap_home/whatap.conf

# 애플리케이션 실행
WHATAP_HOME=./whatap_home ./app 

# WHATAP_HOME 경로 우선 생성 후 whatap.conf 파일 경로 설정
mkdir ./whatap_home1
echo "license={액세스 키}" >> ./whatap_home1/whatap.conf
echo "whatap.server.host={수집 서버 IP 주소}" >> ./whatap_home1/whatap.conf
echo "app_name={애플리케이션 이름-2}" >> ./whatap_home1/whatap.conf

# 애플리케이션 실행
WHATAP_HOME=./whatap_home1 ./app

```

## Golangライブラリの使用

Golangのソースコードにwhatap/go-apiを追加して配布します。

<Tabs groupId="golang">
<TabItem value="redhat-centos" label="Red Hat/CentOS">

```bash
$ go get github.com/whatap/go-api
```

</TabItem>
<TabItem value="debian-ubuntu" label="Debian/Ubuntu">

```bash
$ go get github.com/whatap/go-api/trace
$ go get github.com/whatap/go-api/sql
$ go get github.com/whatap/go-api/httpc
$ go get github.com/whatap/go-api/method
```

</TabItem>
<TabItem value="amazonlinux" label="Amazon Linux">

```bash
$ go get github.com/whatap/go-api/trace
$ go get github.com/whatap/go-api/sql
$ go get github.com/whatap/go-api/httpc
$ go get github.com/whatap/go-api/method
```

</TabItem>
</Tabs>

```go title='GO'
import "github.com/whatap/go-api/trace"

func main(){
    trace.Init(nil)
    //It must be executed before closing the app.
    defer trace.Shutdown()
    ...
}
```

## モニタリングの開始

<Tabs groupId="golang">
<TabItem value="redhat-centos" label="Red Hat/CentOS">

アプリケーションサーバーを再起動すると、エージェントが情報収集を始めます。

</TabItem>
<TabItem value="debian-ubuntu" label="Debian/Ubuntu">

アプリケーションサーバーを再起動すると、エージェントが情報収集を始めます。

</TabItem>
<TabItem value="amazonlinux" label="Amazon Linux">

1.  次のコマンドを実行して、WhaTapエージェントデーモンを実行してください。

    ```bash
    /usr/whatap/php/whatap-agent start
    ```

2.  다음 명령어를 실행해 와탭 서비스가 정상 실행됐는지 확인하세요.

    ```bash
    ps -elf | grep whatap_agent_static
    ```

アプリケーションサーバーを再起動すると、エージェントが情報収集を始めます。

</TabItem>
</Tabs>
