---
id: install-docker-java
title: Docker Javaインストール
description: コンテナ内のJavaアプリケーションをモニタリングするためにエージェントをインストール段階です。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - アプリケーションインストール
  - Java
toc_max_heading_level: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

**_管理_** > **_エージェントインストール_** > 下段の**_アプリケーションインストール_** クリック > 設置案内の中で **_Docker Java_** タブを選択

Dockerコンテナベースで動作するJavaアプリケーションのJVM Optionにエージェント適用の設定を追加し、コンテナイメージをパッケージングする過程を次のように案内します。

:::note 

-   EKS Fargateは、対応予定です。 

-   Javaアプリケーション連動過程に対する理解を助けるためにGit例示コードを提供します。[次の文書](https://github.com/whatap/kuber-apm-boilerplate/tree/main/java/springboot)を参考にしてください。

:::

## エージェントダウンロード

<Tabs groupId='k8stype2'>

<TabItem value="dockerinstall" label="Docker Install" default>

WhaTapアプリケーションエージェントのインストールのために_whatap.conf_ファイルを作成してください。`{YOUR_PROJECT_ROOT}`は、エージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

```bash
cat >{YOUR_PROJECT_ROOT}/whatap.conf <<EOL
whatap.server.host={proxyServer}
EOL
```

:::note

_whatap.conf_ファイルは、Kubernetes環境のConfigMap機能を使用して管理します。

:::

<Tabs>

<TabItem value='latest' label='最新バージョンのエージェントをアプリケーションイメージに含' default>

**最新バージョンのエージェント**をアプリケーションイメージに含めるように案内します。

1.  アプリケーション画像にワタブエージェントを含めるには、まずDockrfileの最終イメージのビルド段階で次の内容を追加してください。`{YOUR_PROJECT_ROOT}`をエージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

    ```docker
    # WhaTapエージェント用のディレクトリをユーザーコンテナに作成
    RUN mkdir -p /whatap

    # WhaTap Javaエージェントをユーザーコンテナにコピー
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap

    # 作成したwhatap.conf設定ファイルをユーザーコンテナにコピー
    COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
    ```

2.  Dockerfileの開始コマンドに次の内容を追加してください。

    ```bash
    -javaagent:/whatap/whatap.agent.kube.jar -Dwhatap.micro.enabled=true
    ```

    次のDockerfileで定義の例を参考にしてください。 

    ```docker title='Dockerfile' showLineNumbers {4,7}
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap
    COPY ./whatap.conf /whatap
    COPY ./target/myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent.kube.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

3.  Dockerをビルドします。`{YOUR_DOCKERFILE_DIR}`をDockerfileが位置したパスに変更してください。 

    ```docker
    cd {YOUR_DOCKERFILE_DIR}
    docker build -t {IMAGE_NAME} .
    ```

</TabItem>

<TabItem value='choice' label='指定したバージョンのエージェントをアプリケーションイメージに含' default>

**指定したバージョンのエージェント**をアプリケーションイメージに含めるように案内します。

1.  アプリケーション画像にワタブエージェントを含めるには、まずDockrfileの最終イメージのビルド段階で次の内容を追加してください。`{YOUR_PROJECT_ROOT}`をエージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

    ```docker
    # WhaTapエージェント用のディレクトリをユーザーコンテナに作成
    RUN mkdir -p /whatap

    # WhaTap Javaエージェントをユーザーコンテナにコピー
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap

    # 作成したwhatap.conf設定ファイルをユーザーコンテナにコピー
    COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
    ```

2.  現在のWhaTapエージェントのバージョンを確認してください。 

    ```bash
    docker run whatap/kube_mon ls /data/agent/micro | grep -E 'whatap\.agent-(.*?\.)(.*?\.)(.*?\.)jar' | sort | tail -1

    # 出力例
    ## whatap.agent-X.Y.Z.jar
    ```

3.  Dockerfileの開始コマンドに次の内容を追加してください。**X.Y.Z**に、前もって確認したエージェントバージョンを入力してください。 

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```

    次のDockerfileで定義の例を参考にしてください。

    ```docker title='Dockerfile' showLineNumbers {4,7}
    FROM openjdk:8-jdk-slim
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap
    COPY ./whatap.conf /whatap
    COPY ./target/myApp.jar /app/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

4.  Dockerをビルドします。`{YOUR_DOCKERFILE_DIR}`をDockerfileが位置したパスに変更してください。

    ```docker
    cd {YOUR_DOCKERFILE_DIR}
    docker build -t {IMAGE_NAME} .
    ```

</TabItem>

</Tabs>

</TabItem>

<TabItem value="direct" label="直接設置">

1.  インストールファイル(_whatap.agent.java.tar.gz_)をダウンロードするには、**_ダウンロード_**ボタンを選択してください。

2.  Dockerfileを作成できるサーバーにアップロードし、圧縮を解凍してください。

    :::info

    インストールするサーバーから直接ダウンロードするには、次のコマンドを実行してください。

    ```bash
    wget https://api.whatap.io/agent/whatap.agent.java.tar.gz
    ```

    :::

3.  圧縮を解除する時、_whatap_ディレクトリが作成されます。_whatap_ディレクトリ内部の_whatap.conf_ファイルで設定内容を確認した後、次のように修正してください。

    ```ini
    license={licenseKey}
    whatap.server.host={proxyServer}
    ```

4.  Dockerfileの開始コマンドに次の内容を追加してください。_whatap_ディレクトリ内でエージェントファイルを確認した後、**X.Y.Z**に該当バージョンを入力してください。

    ```bash
    -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
    ```

    次のDockerfileで定義の例を参考にしてください。

    ```bash title='Dockerfile'
    FROM openjdk:8-jdk-alpine
    RUN mkdir -p /app && mkdir /whatap
    WORKDIR /app
    COPY ./whatap.agent-X.Y.Z.jar /whatap/
    COPY ./whatap.conf /whatap/
    COPY ./target/myApp.jar myApp.jar
    COPY ./paramkey.txt /whatap/
    CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
    EXPOSE 8080
    ```

:::note

-   _whatap-virtual-X.Y.Z.jar_：モニタリング対象(サンプルアプリケーション)

-   _whatap.agent-X.Y.Z.jar_：WhaTapエージェント

-   エージェントのファイル名が_whatap.agent-1.2.3.jar_の場合、**X.Y.Z**の部分を**1.2.3**に変更してください。

-   JVMオプション追加の詳細については、[次の文書](https://docs.whatap.io/java/install-agent#addjvmopt)を参照してください。

:::

</TabItem>

</Tabs>

:::tip

Java 17バージョン以降の場合、reflectionに関する`--add-opens=java.base/java.lang=ALL-UNNAMED`オプションを追加してください。

:::

### Setting the security key {#security}

Set a security key to query SQL variables and perform HTTP queries, or use the Thread stop function.

-   Java Agent 2.2.2 or later

    After creating the _security.conf_ file in the `$WHATAP_HOME` path, enter a 6-character password consisting of alphabets and numbers as follows:

    ```ini title='security.conf'
    paramkey=ABCDEF # SQL variable and HTTP query lookup
    threadkill=ABCDEF # Thread stop function
    ```

-   Java agent 2.2.2 or earlier

    After creating the _paramkey.txt_ file in the `$WHATAP_HOME` path, enter a 6-character password consisting of alphabets and numbers as follows:

    ```ini title='paramkey.txt'
    ABCDEF # SQL variable and HTTP query lookup, thread stop function
    ```

:::tip

When updating the Java agent version to 2.2.2, the key values in the existing _paramkey.txt_ file are automatically applied to the _security.conf_ file. For example, if you used `FEDCBA` in _paramkey.txt_ and updated to the version 2.2.2, it is applied to the _security.conf_ file as follows:

```ini
paramkey=FEDCBA
threadkill=FEDCBA
```

If the _paramkey.txt_ file does not exist, the key value of the _security.conf_ file is automatically created as the key value of **WHATAP**.

:::

:::note

-   For agent settings related to recording SQL parameters, see [the following](agent-dbsql#profile-sql-param).

-   For agent settings related to recording the HTTP parameters, see [the following](agent-transaction#profile_http_parameter).

:::


## コンテナ環境変数の設定

Dockerビルド後、Kubernetes環境内の**コンテナ環境変数**を設定してください。アプリケーションリリーズ_yaml_ファイルに次の内容を追加してください。 

```yaml
env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}
- name: OKIND
	value: {YOUR_OKIND_NAME}
- name: license
	value: {licenseKey}
- name: whatap_server_host
	value: {proxyServer}
- name: whatap_micro_enabled
	value: "true"
```

次の例を参照してください。

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: #DeploymentName
  labels:
    app: #AppLabel
spec:
  selector:
    matchLabels:
      app: #AppLabel
	replicas: 3
  template:
    metadata:
      labels:
        app: #AppLabel
		spec:
		  containers:
			- name: #ContainerName
        image: nginx
        ports:
        - containerPort: 80
			  env:
		    - name: NODE_IP
	        valueFrom: {fieldRef: {fieldPath: status.hostIP}}
				- name: NODE_NAME
		      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
		    - name: POD_NAME
		      valueFrom: {fieldRef: {fieldPath: metadata.name}}
				- name: OKIND
          value: #DeploymentName
				- name: license
					value: {licenseKey}
				- name: whatap_server_host
					value: {proxyServer}
				- name: whatap_micro_enabled
					value: "true"
```

:::note

**環境変数の役割**

-   `NODE_IP`: 現在のPodがホストされているノード(Node)のIPアドレスを収集します。

-   `NODE_NAME`: 現在Podが実行中のノードの名前を収集します。

-   `POD_NAME`: 現在のPodの名前を収集します。

-   `OKIND`(選択事項)：Podに該当するアプリケーションをグループ化します。デプロイメント(Deployment) 名に設定すると、該当するPodを一つにグループ化します。

-   `license`：エージェント認証を確認するためのキーです。

-   `whatap_server_host`：WhaTap収集サーバーのホストIPです。

-   `whatap_micro_enabled`：コンテナとの連動を活性化します。

:::

{@include: _check-install-agent.mdx} 
