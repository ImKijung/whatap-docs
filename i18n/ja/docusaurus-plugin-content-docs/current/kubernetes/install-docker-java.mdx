---
id: install-docker-java
title: Docker Javaインストール
description: コンテナ内のJavaアプリケーションをモニタリングするためにエージェントをインストール段階です。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - アプリケーションインストール
  - Java
toc_max_heading_level: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

**_管理_** > **_エージェントインストール_** > 下段の**_アプリケーションインストール_** クリック > 設置案内の中で **_Docker Java_** タブを選択

Dockerコンテナベースで動作するJavaアプリケーションのJVM Optionにエージェント適用の設定を追加し、コンテナイメージをパッケージングする過程を次のように案内します。

:::note 

- EKS Fargateは、対応予定です。 

- Javaアプリケーション連動過程に対する理解を助けるためにGit例示コードを提供します。[次の文書](https://github.com/whatap/kuber-apm-boilerplate/tree/main/java/springboot)を参考にしてください。

:::

## エージェントダウンロード

<Tabs groupId='k8stype2'>

<TabItem value="dockerinstall" label="Docker Install" default>

WhaTapアプリケーションエージェントのインストールのために *whatap.conf* ファイルを作成してください。`{YOUR_PROJECT_ROOT}`は、エージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

```bash
cat >{YOUR_PROJECT_ROOT}/whatap.conf <<EOL
whatap.server.host={proxyServer}
EOL
```

:::note

*whatap.conf* ファイルは、Kubernetes環境のConfigMap機能を使用して管理します。

:::

<Tabs>

<TabItem value='latest' label='最新バージョンのエージェントをアプリケーションイメージに含' default>

**最新バージョンのエージェント**をアプリケーションイメージに含めるように案内します。

1. アプリケーション画像にワタブエージェントを含めるには、まずDockrfileの最終イメージのビルド段階で次の内容を追加してください。`{YOUR_PROJECT_ROOT}`をエージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

   ```docker
   # WhaTapエージェント用のディレクトリをユーザーコンテナに作成
   RUN mkdir -p /whatap

   # WhaTap Javaエージェントをユーザーコンテナにコピー
   COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap

   # 作成したwhatap.conf設定ファイルをユーザーコンテナにコピー
   COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
   ```

2. Dockerfileの開始コマンドに次の内容を追加してください。

   ```bash
   -javaagent:/whatap/whatap.agent.kube.jar -Dwhatap.micro.enabled=true
   ```

   次のDockerfileで定義の例を参考にしてください。 

   ```docker title='Dockerfile' showLineNumbers {4,7}
   FROM openjdk:8-jdk-slim
   RUN mkdir -p /app && mkdir /whatap
   WORKDIR /app
   COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent.kube.jar /whatap
   COPY ./whatap.conf /whatap
   COPY ./target/myApp.jar /app/
   CMD ["java","-javaagent:/whatap/whatap.agent.kube.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
   EXPOSE 8080
   ```

3. Dockerをビルドします。`{YOUR_DOCKERFILE_DIR}`をDockerfileが位置したパスに変更してください。 

   ```docker
   cd {YOUR_DOCKERFILE_DIR}
   docker build -t {IMAGE_NAME} .
   ```

</TabItem>

<TabItem value='choice' label='指定したバージョンのエージェントをアプリケーションイメージに含' default>

**指定したバージョンのエージェント**をアプリケーションイメージに含めるように案内します。

1. アプリケーション画像にワタブエージェントを含めるには、まずDockrfileの最終イメージのビルド段階で次の内容を追加してください。`{YOUR_PROJECT_ROOT}`をエージェントをインストールしようとするプロジェクトの最上位パスに変更してください。

   ```docker
   # WhaTapエージェント用のディレクトリをユーザーコンテナに作成
   RUN mkdir -p /whatap

   # WhaTap Javaエージェントをユーザーコンテナにコピー
   COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap

   # 作成したwhatap.conf設定ファイルをユーザーコンテナにコピー
   COPY {YOUR_PROJECT_ROOT}/whatap.conf /whatap/
   ```

2. 現在のWhaTapエージェントのバージョンを確認してください。 

   ```bash
   docker run whatap/kube_mon ls /data/agent/micro | grep -E 'whatap\.agent-(.*?\.)(.*?\.)(.*?\.)jar' | sort | tail -1

   # 出力例
   ## whatap.agent-X.Y.Z.jar
   ```

3. Dockerfileの開始コマンドに次の内容を追加してください。**X.Y.Z**に、前もって確認したエージェントバージョンを入力してください。 

   ```bash
   -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
   ```

   次のDockerfileの定義例をご参照ください。

   ```docker title='Dockerfile' showLineNumbers {4,7}
   FROM openjdk:8-jdk-slim
   RUN mkdir -p /app && mkdir /whatap
   WORKDIR /app
   COPY --from=whatap/kube_mon /data/agent/micro/whatap.agent-*.jar /whatap
   COPY ./whatap.conf /whatap
   COPY ./target/myApp.jar /app/
   CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
   EXPOSE 8080
   ```

4. Dockerをビルドします。`{YOUR_DOCKERFILE_DIR}`をDockerfileが位置したパスに変更してください。

   ```docker
   cd {YOUR_DOCKERFILE_DIR}
   docker build -t {IMAGE_NAME} .
   ```

</TabItem>

</Tabs>

</TabItem>

<TabItem value="direct" label="直接設置">

1. インストールファイル(_whatap.agent.java.tar.gz_)をダウンロードするには、**_ダウンロード_**ボタンを選択してください。

2. Dockerfileを作成できるサーバーにアップロードし、圧縮を解凍してください。

   :::info

   インストールするサーバーから直接ダウンロードするには、次のコマンドを実行してください。

   ```bash
   wget https://api.whatap.io/agent/whatap.agent.java.tar.gz
   ```

   :::

3. 圧縮を解除する時、_whatap_ ディレクトリが作成されます。_whatap_ ディレクトリ内部の *whatap.conf* ファイルで設定内容を確認した後、次のように修正してください。

   ```ini
   license={licenseKey}
   whatap.server.host={proxyServer}
   ```

4. Dockerfileの開始コマンドに次の内容を追加してください。_whatap_ディレクトリ内でエージェントファイルを確認した後、**X.Y.Z**に該当バージョンを入力してください。

   ```bash
   -javaagent:/whatap/whatap.agent-X.Y.Z.jar -Dwhatap.micro.enabled=true
   ```

   次のDockerfileの定義例をご参照ください。

   ```bash title='Dockerfile'
   FROM openjdk:8-jdk-alpine
   RUN mkdir -p /app && mkdir /whatap
   WORKDIR /app
   COPY ./whatap.agent-X.Y.Z.jar /whatap/
   COPY ./whatap.conf /whatap/
   COPY ./target/myApp.jar myApp.jar
   COPY ./paramkey.txt /whatap/
   CMD ["java","-javaagent:/whatap/whatap.agent-X.Y.Z.jar","-Dwhatap.micro.enabled=true","-jar","/app/myApp.jar"]
   EXPOSE 8080
   ```

:::note

- _whatap-virtual-X.Y.Z.jar_：モニタリング対象(サンプルアプリケーション)

- _whatap.agent-X.Y.Z.jar_：WhaTapエージェント

- エージェントのファイル名が_whatap.agent-1.2.3.jar_の場合、**X.Y.Z**の部分を**1.2.3**に変更してください。

- JVMオプション追加の詳細については、[次の文書](https://docs.whatap.io/java/install-agent#addjvmopt)を参照してください。

:::

</TabItem>

</Tabs>

:::tip

Java 17バージョン以降の場合、reflectionに関する`--add-opens=java.base/java.lang=ALL-UNNAMED`オプションを追加してください。

:::

### セキュリティキーの設定{#security}

SQL変数、HTTPクエリを検索、Thread停止機能を使用する場合は、セキュリティキーを設定してください。

- Javaエージェント2.2.2バージョン以降

  `$WHATAP_HOME`パスに *security.conf* ファイルを作成した後、次のように 6桁の英数字のパスワードを入力してください。

  ```ini title='security.conf'
  paramkey=ABCDEF # SQL変数およびHTTPクエリの検索
  threadkill=ABCDEF # Thread停止機能
  ```

- Javaエージェント2.2.2バージョン未満

  `$WHATAP_HOME`パスに *paramkey.txt* ファイルを作成した後、次のように 6桁の英数字のパスワードを入力してください。

  ```ini title='paramkey.txt'
  ABCDEF # SQL変数およびHTTPクエリの検索、スレッド停止機能
  ```

:::tip

Javaエージェント 2.2.2 のバージョン未満から2.2.2バージョンにアップデートする場合、既存の *paramkey.txt* ファイルのキー値が _seuciry.conf_ ファイルのキー値に自動的に適用されます。例えば、*paramkey.txt* に`FEDCBA`を使用して、バージョン2.2.2にアップデートした場合、*security.conf* ファイルには次のように適用されます。

```ini
paramkey=FEDCBA
threadkill=FEDCBA
```

*paramkey.txt* ファイルが存在しない場合、*security.conf* ファイルのキー値は、**WHATAP** というキー値で自動的に生成されます。

:::

:::note

- SQLパラメータ情報の記録に関するエージェント設定は、[次の文書](../java/agent-dbsql#profile-sql-param)をご参照ください。

- HTTPパラメータ情報の記録に関するエージェント設定は、[次の文書](../java/agent-transaction#profile_http_parameter)をご参照ください。

:::

## コンテナ環境変数の設定

Dockerビルド後、Kubernetes環境内の**コンテナ環境変数**を設定してください。アプリケーション配布の *yaml* ファイルに次の内容を追加してください。 

```yaml
env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}
- name: OKIND
  value: {YOUR_OKIND_NAME}
- name: license
  value: {licenseKey}
- name: whatap.server.host
  value: {proxyServer}
- name: whatap.micro.enabled
  value: "true"
```

次の例をご参照ください。

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: #DeploymentName
  labels:
    app: #AppLabel
spec:
  replicas: 3
  selector:
    matchLabels:
      app: #AppLabel
  template:
    metadata:
      labels:
        app: #AppLabel
    spec:
      containers:
      - name: #ContainerName
        image: nginx
        ports:
        - containerPort: 80
        env:
        - name: NODE_IP
          valueFrom: {fieldRef: {fieldPath: "status.hostIP"}}
        - name: NODE_NAME
          valueFrom: {fieldRef: {fieldPath: "spec.nodeName"}}
        - name: POD_NAME
          valueFrom: {fieldRef: {fieldPath: "metadata.name "}}
        - name: OKIND
          value: #DeploymentName
        - name: license
          value: #licenseKey
        - name: whatap.server.host
          value: #proxyServer
        - name: whatap.micro.enabled
          value: "true"
```

:::note

**環境変数の役割**

- `NODE_IP`: 現在のPodがホストされているノード(Node)のIPアドレスを収集します。

- `NODE_NAME`: 現在Podが実行中のノードの名前を収集します。

- `POD_NAME`: 現在のPodの名前を収集します。

- `OKIND`(選択事項)：Podに該当するアプリケーションをグループ化します。デプロイメント(Deployment) 名に設定すると、該当するPodを一つにグループ化します。

- `license`：エージェント認証を確認するためのキーです。

- `whatap.server.host`：WhaTap収集サーバーのホストIPです。

- `whatap.micro.enabled`：コンテナとの連動を活性化します。

:::

import Checkinstallagent from "./_check-install-agent.mdx";

<Checkinstallagent />
