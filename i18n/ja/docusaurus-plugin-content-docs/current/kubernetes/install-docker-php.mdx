---
id: install-docker-php
title: Docker PHPインストール
description: コンテナ内のPHPアプリケーションをモニタリングするためのエージェントのインストール段階です。
tags:
  - Kubernetes
  - Kubernetesモニタリング
  - アプリケーションインストール
  - PHP
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Dockerコンテナベースで実行されているPHPアプリケーションにWhaTapモニタリングエージェントを適用し、コンテナイメージをパッケージングするプロセスです。

## エージェントダウンロード

PHPアプリケーションドッカーイメージビルド時whatap-phpパッケージをインストールしてください。

<Tabs>
<TabItem value="rc" label="Red Hat/CentOS" default>

```docker title='Red Hat/CentOS'

RUN rpm -Uvh https://repo.whatap.io/centos/5/noarch/whatap-repo-1.0-1.noarch.rpm
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="du" label="Debian/Ubuntu" default>

```docker title='Debian/Ubuntu'

RUN wget https://repo.whatap.io/debian/release.gpg -O -| apt-key add -
RUN wget https://repo.whatap.io/debian/whatap-repo_1.0_all.deb
RUN dpkg -i whatap-repo_1.0_all.deb
RUN apt-get update
RUN apt-get install -y whatap-php

```

</TabItem>

<TabItem value="al" label="Amazon Linux" default>

```docker title='Amazon Linux'

RUN rpm --import https://repo.whatap.io/centos/release.gpg
RUN echo "[whatap]" | tee /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "name=whatap packages for enterprise linux" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "baseurl=https://repo.whatap.io/centos/latest/\$basearch" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "enabled=1" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN echo "gpgcheck=0" | tee -a /etc/yum.repos.d/whatap.repo > /dev/null
RUN yum install -y whatap-php

```

</TabItem>

<TabItem value="apl" label="Alpine Linux" default>

```docker title='Alpine Linux'

RUN wget https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/alpine/x86_64/whatap-php.tar.gz
RUN tar -xvzf whatap-php.tar.gz -C /

```

</TabItem>

</Tabs>

## エージェント設定

-   次のコマンドを使用してインストールスクリプトを設定してください。 WhaTapアクセスキー、サーバーIP情報を入力すると、PHP環境情報を自動的に収集します。

    ```docker

    RUN (echo "[アクセスキー]"; echo "[サーバーIP]")|/usr/whatap/php/install.sh

    ```

-   次のような方法でPHP環境情報を直接入力することもできます。 

    ```docker

    # RUN /usr/whatap/php/install.sh -l アクセスキー] -s [サーバーIP] -v [PHPバージョンx.x] -i [php.iniのフルパス] -p [プロセス名] -z [thread safety] 
    RUN /usr/whatap/php/install.sh -l xxxxx -s 1.1.1.1/2.2.2.2 -v 7.0 -i /etc/php.ini -p httpd [-z]

    ```

## Kubernetes環境変数およびボリューム

次の案内に従って、環境変数とボリュームを設定してください。

<Tabs>
<TabItem value='basic' label='デフォルト' default>

トランザクションからNodeおよびPod情報を収集するには、`NODE_IP`、`NODE_NAME`、`POD_NAME`を環境変数として設定してください。 WhaTap設定ファイルおよびログファイル用のテンポラリーボリュームを設定します。

```docker

env:
- name: NODE_IP
  valueFrom: {fieldRef: {fieldPath: status.hostIP}}
- name: NODE_NAME
  valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
- name: POD_NAME
  valueFrom: {fieldRef: {fieldPath: metadata.name}}

```

</TabItem>

<TabItem value="eks" label="EKS Fargate" default>

-   **shareProcessNamespaceの設定を追加**

    デプロイメント(Deployment)またはレプリカセット(ReplicaSet)の_.spec_内のフィールドにユーザPodリソースを観測するための 
    `shareProcessNamespace`、`SERVICE ACCOUNT`を追加してください。

    ```docker

    apiVersion: apps/v1
    kind: Deployment
    ...
    spec:
    ...
        spec:
          shareProcessNamespace: true
          serviceAccount: whatap
    ...

    ```

-   **Kubernetesのコンテナ環境変数の設定**

    トランザクションからNodeおよびPod情報を収集するには、`NODE_IP`、`NODE_NAME`、`POD_NAME`を環境変数として設定してください。 WhaTap設定ファイルおよびログファイル用のテンポラリーボリュームを設定します。

    ```docker

    env:
    - name: NODE_IP
      valueFrom: {fieldRef: {fieldPath: status.hostIP}}
    - name: NODE_NAME
      valueFrom: {fieldRef: {fieldPath: spec.nodeName}}
    - name: POD_NAME
      valueFrom: {fieldRef: {fieldPath: metadata.name}}

    ```

-   **Sidecar（サイドカー）エージェントの追加**

    ユーザーPod(Pod) リソースの使用量を収集するwhatap-node-agent sidecarコンテナを追加します。

    ```docker

    ...
      - name: whatap-node-agent
        image: whatap/kube_mon_sidecar
        resources:
          requests:
            memory: 20Mi
            cpu: 10m
          limits:
            memory: 40Mi
            cpu: 20m
        ports:
          - name: nodeport
            containerPort: 6600
        env:
          - name: NODE_IP
            valueFrom:
              fieldRef:
                fieldPath: status.hostIP
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
            envFrom:
            - configMapRef:
                name: node-license
    volumes:
    ...

    ```

</TabItem>

</Tabs>

## アプリケーションモニタリングの開始

<Tabs>
<TabItem value="cm" label="Command" default>

アプリケーション開始コマンドの前にwhatap-phpサービス開始コマンドを追加してください。 

```docker title='Red Hat/CentOS, Debian/Ubuntu, Amazon Linux'

sh -c "/etc/init.d/whatap-php start && [アプリケーション開始コマンド]"

```

```docker title='Alpine Linux'

sh -c "/usr/whatap/php/whatap-php start && [アプリケーション開始コマンド]"

```

</TabItem>

<TabItem value="sup" label="Supervisor" default>

Supervisorでアプリケーションを起動する場合は、次のコードを参考にしてwhatap-phpサービスを追加してください。

```docker

RUN echo "[program:whatap-php]" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "command = /etc/init.d/whatap-php start" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "user = root" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autostart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "autorestart = true" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile = /dev/stdout" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stdout_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile = /dev/stderr" >> /etc/supervisor/conf.d/whatap.conf
RUN echo "stderr_logfile_maxbytes=0" >> /etc/supervisor/conf.d/whatap.conf

```

</TabItem>

</Tabs>

次のコマンドを実行して、WhaTapサービスが正常に実行されていることを確認してください。 

```docker

ps -ef | grep whatap_php

```

## エージェントのインストール確認

エージェントが正常にインストールされたことを確認するには、**_ダッシュボード_** > **_アプリケーションサービスダッシュボード_**メニューに移動してください。

ダウンロードしたファイルをインストールした後に**_ダッシュボード_**メニューからエージェントが表示されない場合は、次の事項を確認してください。

-   コンテナで`ps -ef | grep whatap`コマンドを実行し、エージェントオプションを適用されていることを確認してください。
-   該当コンテナ内の_/usr/whatap/php/logs_経路の内容を確認してください。 エージェントログは、_logs/whatap-`{bootまたはinstall}`-yyyymmdd.log_形式のファイル名で出力されます。
