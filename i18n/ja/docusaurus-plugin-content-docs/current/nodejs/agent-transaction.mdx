---
id: agent-transaction
title: トランザクション
description: エージェントのトランザクションパフォーマンスを追跡および設定するためのオプションを提供します。
tags:
  - Node.js
  - トランザクション
---

import Transaction from "../common-items/_transaction.mdx";

<Transaction />

エージェントでトランザクションのパフォーマンスを追跡および設定するため、次のオプションを提供します。

## トランザクショントレーシング

import Transactionprofilingcommon from "../common-items/_transaction-profiling-common.mdx";

<Transactionprofilingcommon />

- **profile_error_step_enabled** <span class='type'>Boolean</span>

  デフォルト値 `true`

  プロファイルにエラー関連情報を表示するステップを追加できます。

import Transactionprofileactivecolor from "../common-items/_transaction-profile-active-color.mdx";

<Transactionprofileactivecolor />

- **hook_method_patterns** <span class='type'>String</span>

  レスポンス時間を測定するメソッドを設定します。最後のピリオド(.)を区切り文字としてクラスのFullNameとメソッドに区分され、アスタリスク(\*)をワイルドカードとして使用することができます。対象が複数ある場合は、コンマ(,)で区切ります。

  ```ini title='Example'
  hook_method_patterns=a.b.C1.*
  ```

- **hook_method_access_public_enabled** <span class='type'>Boolean</span>

  デフォルト値 `true`

  メソッドトレースを設定する場合、publicメソッドを個別のターゲットとしてのみ処理するかどうかを設定します。

- **hook_method_access_protected_enabled** <span class='type'>Boolean</span>

  デフォルト値 `true`

  メソッドトレースを設定する場合、protectedメソッドに限り、個別の対象として処理するかどうかを設定します。

- **hook_method_access_private_enabled** <span class='type'>Boolean</span>

  デフォルト値`false`

  メソッドトレースを設定する場合、privateメソッドに限り、個別の対象として処理するかどうかを設定します。

- **hook_method_access_none_enabled** <span class='type'>Boolean</span>

  デフォルト値 `true`

  メソッドトレースを設定する際、no access indicatedメソッドに限り、別途対象として処理するかを設定します。

- **hook_method_ignore_prefixes** <span class='type'>String</span>

  デフォルト値`get,set `

  メソッドトレースを設定する場合、トレースから除外するクラスをprefixに設定します。

- **hook_method_ignore_classes** <span class='type'>String</span>

  メソッドトレースを設定する場合は、トレースから除外するクラスをprefixに設定します。

- **trace_service_port_enabled** <span class='type'>Boolean</span>

  デフォルト値`false`

  トランザクション名にポート番号を追加します。

- **httpc_status_ignore** <span class='type'>String</span>

  デフォルト値`Empty`

  HTTPのステータスコードがエラー(`HTTPC_ERROR`)の場合、無視します。複数の値を対象にする場合は、コンマ(,)を区切り文字として使用してください。

  ```ini title='whatap.conf'
  httpc_status_ignore=404,500
  ```

- **httpc_status_ignore_set** <span class='type'>String</span>

  デフォルト値`Empty`

  `whatap.error.HTTPC_ERROR`を無視します。複数の値を対象とする場合は、コンマ(,)を区切り文字として使用してください。

  :::note

  `httpc_status_ignore_set=/a/b/c:400,/a/ab/c:404`に設定します。 この時に、URLは統計/エラー分析に`HTPC_URL`の値を入力します。

  :::

## HTTPトランザクションの追跡

import Transactiontracecommon from "../common-items/_transaction-trace-common.mdx";

<Transactiontracecommon /> 

import Transactionprofilehttp from "../common-items/_transaction-profile-http.mdx";

<Transactionprofilehttp /> 

- **trace_ignore_url_set** <span class='type'>String</span>

  トランザクション追跡から除外するURLを設定します。2つ以上の値を設定する場合は、コンマ(,)を区切り文字として使用します。

- **trace_ignore_url_prefix** <span class='type'>String</span> <ScrollToLink anchor="trace_ignore_url_prefix" />

  トランザクション追跡から除外するURL prefixを設定します。2つ以上の値を設定する場合は、コンマ(,)を区切り文字として使用します。

- **ignore_http_method** <span class='type'>String</span>

  デフォルト値 `PATCH,OPTIONS,HEAD,TRACE`

  設定したHTTPメソッド(Method)で要求されたトランザクション情報は収集しません。複数設定するには、コンマ(,)を区切り文字として利用してください。

  ```ini title="whatap.conf"
  # e.g. http_methodがOPTIONS、HEADであるトランザクションを「追跡」
  ignore_http_method=PATCH,TRACE

  # e.g. http_methodがOPTIONS、HEADであるトランザクションを「無視」
  ignore_http_method=OPTIONS,HEAD
  ```

- **profile_http_header_ignore_keys** <span class='type'>String</span>

  デフォルト値 `Cookie,cookie,accept,user-agent,referer`

  HTTPヘッダー名を指定して収集情報から除外できます。指定したHTTPヘッダー名の値は収集から除外され、'#'と表示されます。

- **profile_http_parameter_keys** <span class='type'>String</span>

  設定されたキーに該当するパラメータ情報のみを記録します。複数を登録するときは、コンマ(,)を区切り文字として利用してください。設定しない場合、すべてのパラメータ情報が記録されます。

- **status_ignore** <span class='type'>String</span>

  デフォルト値`Empty`

  無視するHTTPのステータスコードを設定できます。複数の値を対象とする場合は、コンマ(,)を区切り文字として使用してください。

  ```ini title='whatap.conf'
  # example
  status_ignore=408,500
  ```

- **status_ignore_set** <span class='type'>String</span>

  デフォルト値`Empty`

  HTTPステータスリターンコードの中で無視したいコードをURL単位で設定できます。

  ```ini title='whatap.conf'
  # example
  status_ignore_set=/api/test/timeout/{time}:408,/api/test/timeout:200,/error:500
  ```

- **transaction_status_error_enable** <span class='type'>Boolean</span>

  デフォルト値 `true`

  正常応答ではなくHTTP401、403のようなステータスコードがリターンされた場合、エラーとして処理するかどうかを設定します。

## 非HTTPトランザクションのトレース

- **hook_service_patterns** <span class='type'>String</span>

  NON-Httpトランザクション追跡のための開始点パターンを設定します。ワイルドカード文字は使用できません。2つ以上の値を設定するにはコンマ(,)を区切り文字として利用してください。

- **trace_background_socket_enabled** <span class='type'>Boolean</span>

  デフォルト値 `true`

  ソケット (TCP) がトランザクションではなくバックグラウンドスレッドによってオープンされた場合に接続がオープンされ、トランザクションが開始された場合にのみ、オープントレースします。

## マルチトランザクショントレース

- **mtrace_rate** <span class='type'>Int</span>

  デフォルト値`0`

  最初のトランザクションが発生したときに発行されるマルチトランザクション追跡機能(Multi Transaction ID、以下MTID)の発行レートを設定するオプションです。`0`から`100`まで設定できます。MTIDを追跡することで、登録したすべてのアプリケーション間の呼び出しを確認できます。同じプロジェクトに属するアプリケーションは、CallerとCallee機能を使用してトランザクションのトレースを直接確認することができます。

- **mtrace_spec** <span class='type'>String</span>

  デフォルト値`v1`

  現在のインスタンスのアプリケーションのバージョンを設定します。任意の文字列を入力できます。このデータは、呼び出し統計のために使用します。

- **mtrace_caller_key** <span class='type'>String</span>

  デフォルト値`x-wtap-mst`

  MTID追跡に使用するCaller Key Nameを設定します。

- **mtrace_callee_key** <span class='type'>String</span>

  デフォルト値`x-wtap-tx`

  MTID追跡に使用するCallee Key Nameを定義します。

- **mtrace_callee_id_recv_enabled** <span class='type'>Boolean</span>

  デフォルト値`false`

  MTID追跡時に受信したCallee IDのトレースを表します。

- **mtrace_alltx_enabled** <span class='type'>Boolean</span>

  デフォルト値`false`

  log4jなどのロギングシステムに接続するために、すべてのトランザクションのMTIDを追跡できます。

- **mtrace_basetime** <span class='type'>Miliseconds</span>

  デフォルト値`100`

  `mtrace_alltx_enabled`オプションの値が`true`の場合、多くのログが残る可能性があります。この場合、トレースログの量を減らす必要があります。

- **stat_mtrace_enabled** <span class='type'>Boolean</span>

  デフォルト値`false`

  CallerとCalleeの相関統計を収集します。Callerに適用するとCallerの詳細情報が送信され、Calleeを適用するとurl単位のCaller-Calleeの呼び出し統計情報が収集サーバーに送信されます。

## トレースデータサンプリング

<code class="my">Node.js Agent v0.4.94 or later</code>

:::note

[Node.jsエージェントv0.4.94バージョン](../release-notes/nodejs/nodejs-0_4_94)に[socket.io](http://socket.io)モニタリングモジュールを追加しました。`trace_sampling_enabled`、`trace_sampling_tps` オプションを使用して、サンプリングされたデータを確認できます。[`trace_ignore_url_prefix`](#trace_ignore_url_prefix)オプションに`/socket.io`パスを追加して、トレースしないように設定してください。

:::

- **trace_sampling_enabled** <span class='type'>Boolean</span>

  デフォルト値 `false`

  トレースデータサンプリングの収集有無を設定できます。

- **trace_sampling_tps** <span class='type'>Number</span>

  デフォルト値 `1000`

  トレースデータサンプリングの数を設定できます。設定したサンプリング数を超えるデータは送信せず、1秒ごとに初期化します。
