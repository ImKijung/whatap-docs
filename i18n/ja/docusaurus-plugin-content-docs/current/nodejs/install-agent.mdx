---
id: install-agent
title: Node.jsエージェントのインストール
description: Node.js環境のアプリケーションサーバーにエージェントをインストールする方法を提供します。
tags:
  - Node.js
---

import TR from '@site/src/components/TR';

{@include: ../common-items/_agent-signup-guide.mdx}   

{@youtube: 5kwc_Xne5Ok}

Node.jsモニタリングサービスを使用するには、モニタリング対象アプリケーションにモニタリングエージェントをインストールする必要があります。インストールはnpm(Node Package Manager)を使用してください。

- サービス中のNode.jsアプリケーションのディレクトリパスに、WhaTapエージェントモジュールをインストールしてください。

- WhaTapエージェントの環境設定(_whatap.conf_)を作成してください。

- Node.jsサービスを再起動します。

{@include: ../getting-started/_create-project-v2.mdx}

{@include: ../getting-started/_accesskey-v2.mdx} 

## エージェントダウンロード

1. サービス中のNode.jsアプリケーションのディレクトリパスに、エージェントモジュールをインストールしてください。

   ```bash
   $ npm install --save whatap
   ```

2. _node_modules/whatap_パスから_whatap.conf_ファイルをコピーして、ソースコードのルート(root)パスに貼り付けます。

3. [WhaTapモニタリングサービス](https://service.whatap.io) 画面に移動してください。

4. 作成したプロジェクトを選択し**_インストール手順_**セクションの**_エージェントのダウンロード_** セクションから、次をコピーしてください。

   ```ini title='Example'
   license={アクセスキー}
   whatap.server.host={収集サーバーIP}
   ```

5. _whatap.conf_ファイルに貼り付けてください。

ホスト(`whatap.server.host`) のアドレスは、WhaTap proxyをインストールしたサーバーのアドレスです。スラッシュ(「/」)を区切り文字として使用し、WhaTap proxy が実行中のサーバーにアドレスを入力することができます。

<details>
<summary>Node.jsエージェント構成ファイル</summary>

Node.jsモニタリングサービスを構成する各ファイルの役割は、次のとおりです。

- _whatap.conf_：エージェント設定ファイルのサンプルです。そのファイルをコピーして、アクセスキーを入力してください。

- _lib_：エージェント、トレーサープログラムです。

- _README.md_：エージェントのインストールに関する手順書です。

- _package.json_：npmモジュール環境構成ファイルです。

- _index.js_：main export宣言ファイルです。

</details>

## 活用方法

アプリケーションの進入点(メインモジュール)ファイルの最上段に次のコードを追加してください。例えばExpress.jsアプリケーションでは_app.js_または_server.js_ファイルが進入点(メインモジュール)です。Nest.jsといったフレームワークを使用する場合は、_main.ts_ファイルなどです。

```javascript title='Javascript'
var whatap = require('whatap').NodeAgent;
```

ECMAScript(ES)を使用している場合、次のコードを追加してください。

```javascript title='ES'
import WhatapAgent from 'whatap';
WhatapAgent.NodeAgent;
```

次の適用例を参照してください。

```javascript
var WhatapAgent = require('whatap').NodeAgent;
import http from 'http';
import setupApp from '../src/app';
let server = null;
const port = normalizePort(process.env.PORT || '3000');
```

:::note

エージェントの実行コードは、node.jsを起動してから実行する必要があります。最初の`import`の前にセットする必要があります。

:::

インストールが完了したら、[次の文書](install-check)を確認して問題がないことを確認してください。

### 環境別にwhatap.confファイルを区分して使用する

次の場合に該当する場合は、.confを除いたファイル名を設定してください。

- 環境別にプロジェクトを分割している場合

- 異なるエージェントのオプションを設定する場合

- pm2でクラスター(Cluster) モードを起動する場合

```javascript
process.env.WHATAP_CONF = 'whatapdev';
process.env.WHATAP_NAME = 'NodeAgent-{ip2}-{ip3}-{cluster}';
var WhatapAgent = require('whatap').NodeAgent;
```

:::note

`WHATAP_NAME`オプションで設定できる引数は次のとおりです。

- **ipN**：ip0、ip1、ip2、ip3

- **cluster**：cluster ID

- **pid**：process ID

- **hostname**：ホスト名

:::

### エージェントのグループ単位の機能を使用する

エージェントのグループ単位の機能には、グループトポロジ、統合トポロジなどがあります。次のコードは、`{グループ識別子}`の部分をエージェントグループ名に置き換えて使用してください。

```javascript
process.env.WHATAP_OKIND = '{グループ識別子}';
var WhatapAgent = require('whatap').NodeAgent;
```

## PaaSのアプリケーション環境

### デフォルトの環境変数設定

PaaSアプリケーションからエージェントをインストールする場合は、すべての設定をソース(_app.js_)ファイルで設定する必要があります。_whatap.conf_ファイルは使用できません。

アクセスキー(`WHATAP_LICENSE`)収集サーバーIP(`WHATAP_SERVER_HOST`)を環境変数として設定してください。

```javascript title='app.js'
process.env.WHATAP_LICENSE={アクセスキー};
process.env.WHATAP_SERVER_HOST={収集サーバーIP};
var whatap=require('whatap').NodeAgent;
...
```

### 環境変数として設定可能なオプション

_whatap.conf_ファイルが使用できないため、ソースファイルに環境変数としてWhaTapエージェントオプションを設定する必要があります。

```javascript title='app.js'
process.env.profile_http_header_enabled=false;
process.env.profile_http_parameter_enabled=false;

process.env.profile_basetime=500;

process.env.auto_oname_enabled=false;
process.env.auto_oname_prefix='nodejs';

process.env.mtrace_rate=0;
process.env.mtrace_spec='v1';
process.env.stat_mtrace_enabled=false;
process.env.stat_domain_enabled=false;
```

:::note

Node.jsで設定できるオプションの詳細については、[次の文書](set-agent)を参照してください。

:::

## モニタリングの開始

アプリケーションサーバーを再起動すると、エージェントが情報収集を開始します。
