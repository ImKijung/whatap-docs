---
id: log-db
title: 応募方法
description: データベースとAWS RDSのログを収集する方法をご案内します。
tags:
  - ログモニタリング
  - データベース
  - PostgreSQL
---

WhaTapは、データベースのログモニタリングサービスを提供します。 サーバーインストール型データベースとクラウドサービスであるAWS RDSのログを収集できます。 これにより、WhaTapのログモニタリング機能である**_ライブテール_**、**_ログトレンド_**メニューからデータベースの散らばったログを一目で確認することができます。

:::tip

ログモニタリングを適用した後は、各メニューの**_カテゴリ_**項目とログ一覧からインストール型DBは、 `#DB`、AWS RDSは`#RDS_LOG`、`#RDS_EVENT`と表示されます。

<ImgLang img='db-log-category.png' desc='카테고리' />

:::

## サーバーインストール型DB

サーバーインストール型データベースのログをモニタリングするには、WhaTapの_xos.conf_ファイルに次のオプションを適用してください。

<InDoc product='mysql'>

```ini title='xos.conf'
file=/var/log/mysqld.log
file1=/var/log/mysql_history.log
file2=/var/lib/mysql/dbx-database-slow.log
```

</InDoc>

<InDoc product='postgresql'>

```ini title='xos.conf'
file=/opt/postgresql/logs/postgresql.log
file1=/opt/postgresql/data/logs/pg10/postgresql-Sun.log
file2=/opt/postgresql/data/logs/pg10/postgresql-Mon.log
file3=/opt/postgresql/data/logs/pg10/postgresql-Tue.log
```

</InDoc>

:::note

適用する前に、XOSエージェントをインストールしてエージェント設定を進める必要があります。 詳細については、[次の文書](agent-xos-settings)を参照してください。

:::

## AWS RDS Log

AWSはRDSのモニタリングのために様々な情報を提供しますが、これらの情報を確認するにはAWSコンソールに直接アクセスする必要があります。 しかし、WhaTapの**AWS RDS Log**はデータベースモニタリングの**_ログ_**メニューでRDSのログとイベントを提供します。

![AWS RDS Log](/img/aws-rds-log-diagram.png)

**AWS RDS Log**は[AWS CloudFormation](https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/Welcome.html)を通じてインストールすることができます。

### 権限確認

**AWS CloudFormation**を通じて**AWS RDS Log**をインストールするには、必須のIAM権限を確認してください。

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudformation:CreateStack",
        "cloudformation:UpdateStack",
        "cloudformation:DeleteStack",
        "cloudformation:DescribeStacks",
        "cloudformation:DescribeStackEvents",
        "cloudformation:DescribeStackResource"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:CreateBucket",
        "s3:PutBucketVersioning",
        "s3:PutBucketPublicAccessBlock"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "lambda:CreateFunction",
        "lambda:UpdateFunctionCode",
        "lambda:UpdateFunctionConfiguration",
        "lambda:DeleteFunction",
        "lambda:AddPermission"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:GetRole",
        "iam:AttachRolePolicy"
      ],
      "Resource": "*"
    }
  ]
}
```

### 生成リソースを確認する

**AWS CloudFormation**からインストールされているリソースを確認してください。

![AWS RDS Log](/img/aws-rds-log-resource.png)

-   **S3** 

    -   Bucket:WhaTap**AWS RDS Log**の実行ファイルを保存するAWS S3 Bucket (CopyZips)

-   **Lambda**

    -   Function 

        -   CopyZipsFunction:WhaTap AWS S3 Bucketからユーザの環境に実行ファイルを移すAWS Lambda Function

        -   WhaTapRDSLog: AWS RDSのモニタリングのためのAWS Lambda Function

    -   Permission

        -   CWPermission: RDS CloudWatchLogGroupにLogが生成されるとき、WhaTapRDSLogを実行できるようにしてくれるPermission

        -   EventBridgePermission: RDS Eventが発生した場合、EventBridgeでWhaTapRDSLogを実行できるようにしてくれるPermission

    -   Role

        -   CopyZipsFuntionがWhaTapのS3からファイルをインポートし、CopyZipsで入れるために必要なRole

        -   WhaTapRDSLogがCloudWatchLogGroupにLogを残すために必要なRole

### インストール

[AWS CloudFormation](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/quickcreate?stackName=WhaTapRDS&templateURL=https://whatapforwarder.s3.ap-northeast-2.amazonaws.com/WhaTapRDSLogInstall.template)画面に接続してください。 **パラメータ**セクションに次の項目を入力してください。

-   **Host**: WhaTap収集サーバーアドレス、WhaTapプロジェクトの**_管理_**>**_エージェントインストール_**メニューで確認できます。 例）13.124.11.223/13.209.172.35

-   **MemorySize**: WhaTapRDSLogのメモリサイズ、128MB ~ 10,240MB間の値を入力してください。

-   **Pcode**: WhaTapプロジェクトのプロジェクトコード、**管理**>**プロジェクト管理\***メニューで**_プロジェクトコード_**項目を確認してください。

-   **ProjectAccessKey**: WhaTapプロジェクトのアクセスキー、**_管理_**>**_プロジェクト管理_**メニューで**_プロジェクトアクセスキー_**項目を確認してください。

-   **TimeOut**: インストールされるWhaTapRDSLogが実行時に最大に維持される時間です。

-   **UseReservedConcurrency**: WhaTapRDSの予約された同時性の使用有無です。

-   **ReservedConcurrency**: WhaTapRDSが予約された同時性を使用したときに、同時に実行できる最大インスタンスの数です。

#### Output

![AWS CloudFormation output](/img/aws-rds-log-setting-output.png)

### フィルターおよびルールを確認する

![AWS CloudFormation](/img/aws-rds-log-check-resources.png)

-   **WS CloudWatchLogGroup**

    SubscriptionFilter(1~9): RDSの CloudWatch LogGroupに Logが入ってきたらWhatapRDSLogを実行させるフィルター

-   **AWS EventBridge**

    Rule: AWSイベントで、RDSと関連のイベントが発生するとWhatapRDSLogを実行させるルール

### 設定

[AWS CloudFormation](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/quickcreate?stackName=whataprdseventforwarder&templateURL=https://whatapforwarder.s3.ap-northeast-2.amazonaws.com/WhaTapRDSLogSetting.template)画面に接続してください。 **パラメータ**セクションに次の項目を入力してください。

![AWS CloudFormation](/img/aws-rds-log-set-parameter.png)

-   **AwsRdsNames**: イベントを受けようとするRDS Cluster、Instanceの名前一覧

    -   例）database-1、seoul-pro-db-01、seoul-pro-db-01-writer …

    -   EventRuleを生成しないためには、`none`を入力してください。

-   **RdsLogGroupName(1~9)**: ログを受け取りたいRDS CloudWatchLogGroup Name

    -   例）/aws/rds/seoul-pro-db-01

    -   サブスクリプションフィルターを生成しない場合は、 `none `を入力してください。

-   **WhaTapRDSLogArn**: 前の段階で生成されたWhaTapRDSLogArn(出力にある)

:::note

CloudWatchLogGroupは一度に最大9つまで接続できます。

:::
